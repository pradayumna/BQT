---
title: "BQT_Project"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

  
# Replication of Lindo, Jason M., Nicholas J. Sanders, and Philip Oreopoulos. 2010. "Ability, Gender, and Performance Standards: Evidence from Academic Probation."   
## American Economic Journal: Applied Economics, 2 (2): 95-117.DOI: 10.1257/app.2.2.95
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```
### Overview  
Universities, to ensure all students meet a minimum academic standard, implement a minimum Grade Point Average (GPA) that, if not met, results in the student being placed on academic probation. The student must then increase their subsequent year and average GPA to meet this minimum, otherwise risk academic suspension.  
The above paper uses data of students academic standing over the period of their studies to assess the effect of placing students who fail to meet a minimum academic standard on probation.  

The data includes a number of student characteristics (e.g. age, sex, high school grades, first language, birthplace) which are assessed to determine if any particular characteristic shows an increase in probability of a decision to leave or continue studying.   

The regression discontinuity model is used to perform the analysis as it can assess if there is a significant difference in the outcomes between the treatment group (those placed on academic suspension) and the control group (those not placed on academic suspension).  

The paper selected suggested that when students are placed on academic probation it can result in students not returning to university in the following year, and for those students who do return, an increase in their performance. When the observable characteristics are assessed, male students are more likely to drop out than female students when put on academic probation.  

The descriptive analyses replicated from the study are:  
- Statistical data of the observational data  

The inferential analyses replicated from the study are:  
- assessment of the linear model to confirm linear regression model assumptions are met.  
- discontinuity of the frequency of students on probation in the first year. This analysis can identify if there is any grouping of data suggesting a non random sorting across the threshold. 
- assessment of the student characteristics to check for discontinuity between the treatment and control group. A discontinuity between these two groups suggests a particular characteristic may influence a students grade.  
- if being placed on academic probation impacts the likelihood of the student leaving university the year following probation,    
- if being placed on probation affects the prbability of graduating.  
Figures associated with each of these analysis will also be replicated.  

The free roam section of this report looks at some of the characteristics not assessed as part of the original report to determine if if there is a difference in response to probation based on these characteristics, and if these characteristics further support or contradict the study findings.  

Most data cleaning had been performed by the original authors (removing students with missing data and those who did not have the academic standard assessed at the end of the first year) it was noted that there are discrepancies in the data range reported in the original study and the data available for review and replication. The report states academic standing data was collected in the years 1995 to 2004 however review of the reported first year confirmed the range of data supplied is 1996 to 2003.
```{r error=FALSE, warning=FALSE, include=FALSE}
library(qwraps2)
library(formattable)
library(knitr)
library(foreign)
library(ggplot2)
library(sandwich)
library(lmtest)
library(dplyr)
data_main <- read.dta("~/ECOM5002/Project/data.dta")
```

```{r, echo=FALSE}
summary(data_main$firstyear)
```
This has resulted in the inability replicate the results exactly as per the original report.   

It was also noted that the original data had several points where students who did not meet the minimum GPA were not recorded as being placed on academic probation.
```{r, echo = FALSE}
data1 <- data_main[data_main$dist_from_cut > -1.4 & data_main$dist_from_cut < 1.4, ]
data_clean <- subset(data1, left_school==0)
```

```{r, echo = FALSE}
plot(data1$dist_from_cut,data1$probation_year1, xlab = 'Distance from Cutoff', ylab = 'On Probation First year')
```

This data has been left in the analysis as we cannot confirm the accuracy of this data and therefore do not have sufficient justification  to remove it.  

### Descriptive Replication  
The data provided is based on GPA results from three different university campuses, one of which has a different cutoff GPA from the others. To allow for the use of all data based on the same cutoff point the original data includes an output variable of the students GPA distance from the specific campuses GPA cutoff. Using this value the cutoff point is set as 0. The data provided spans a bandwidth of 1.4 GPA points above and below the probation cutoff (0).  


Table 1 is the descriptive statistics for the data and replicates Table 1 in the original study. Results are similar to the original report descriptive statistics with male students representing 38% of the sample and 87% of students born in North America.  
```{r, echo = FALSE, warning=FALSE}
descriptive_summary <- list("Characterisitcs" = list('High School Grade Percentile' =~ qwraps2::mean_sd(hsgrade_pct),
                                                     'Credits Attempted in First Year' =~ qwraps2::mean_sd(totcredits_year1),
                                                     'Age at entry' =~ qwraps2::mean_sd(age_at_entry),
                                                     'male' =~ qwraps2::mean_sd(male),
                                                     'English is First Language' =~ qwraps2::mean_sd(english),
                                                     'Born in North America' =~ qwraps2::mean_sd(bpl_north_america),
                                                     'At Campus 1' =~ qwraps2::mean_sd(loc_campus1),
                                                     'At Campus 2' =~ qwraps2::mean_sd(loc_campus2),
                                                     'At Campus 3' =~ qwraps2::mean_sd(loc_campus3)), 
                            "Outcomes" = list('Distance from Cutoff in 1st Year' =~ qwraps2::mean_sd(dist_from_cut),
                                              'On Probation After 1st Year' =~ qwraps2::mean_sd(probation_year1),
                                              'Ever on Academic Probation' =~ qwraps2::mean_sd(probation_ever),
                                              'Left University after 1st Evaluation' =~ qwraps2::mean_sd(left_school),
                                              'Distance from Cutoff Next Evaluation' =~ qwraps2::mean_sd(nextGPA, na_rm = TRUE, show_n = 'never'),
                                              'Ever Suspended' =~ qwraps2::mean_sd(suspended_ever, na_rm = TRUE, show_n = 'never'),
                                              'Graduated by Year 4' =~ qwraps2::mean_sd(gradin4, na_rm = TRUE, show_n = 'never'),
                                              'Graduated by Year 5' =~ qwraps2::mean_sd(gradin5, na_rm = TRUE, show_n = 'never'),
                                              'Graduated by Year 6' =~ qwraps2::mean_sd(gradin6, na_rm = TRUE, show_n = 'never')))
options(qwraps2_markup = "markdown")
table1 = summary_table(data1, descriptive_summary)
```

```{r, echo = FALSE, warning=FALSE}
kable(table1, caption = 'Table 1')
```

### Inferential Replication
#### Testing for Regression Analysis Assumptions
In order to use a Linear Regression model the following assumptions have to be met:  
1. Expected value of fitted values (residuals) are 0  
2. Variables of the residuals are constant and doesn't depend on I  
3. The error (residual) of one observation is independent of the error of another  
4. For statistical inference, the residuals are normally distributed, centred around zero, and have a constant variance.  
As the assessment we are replicating is the impact of being put on probation to a students next GPA result, this data was assessed to confirm that it meets the above assumptions.   
```{r}
glm <- lm(nextGPA ~ gpalscutoff + gpaXgpalscutoff + gpaXgpagrcutoff+ gpasqXgpagrcutoff, data = data_clean)
plot(glm)
```

The residuals vs fitted values plot shows the data is distributed above and below the line suggesting there is a linear relationship between the x and y values. it is noted that there is a decreasing trend in the data.  
The scale location plot suggest the residuals of the data do not have constant variance as the width of the data spread appears to increase.  
The the data below approximately -1 quantile on the Q-Q plot departs from the line therefore it cannot be assumed that the data is normally distributed.  
There are no significant outliers observed in the Residuals vs Leverage plot.

#### Testing for conditions of RDD  
The Regression Discontinuity Design (RDD) model uses a continuous variable W (running variable) and assessed B1 close to the cutoff point c to assess for an approximation of the treatment affect. Value of W (in this study; the distance from cutoff) below c (in this study; the cutoff is 0) are the treatment group and values above c did not receive the treatment.  
$$
Y{i}=\hat{\beta}_0+\hat{\beta}_1X{i}+\hat{\beta}_2W{i}+u_i
$$
$$
Xi = \left\{\begin{array}{l} 1,\ \ \ \ Wi \ge c \\
0,\ \ \ \ Wi < c
\end{array}\right\}
$$
RDD measures the change in the probability at c (the discontinuity) and is used to estimate the effect of the treatment based on the size of the discontinuity at c.  
RDD requires that outputs close to the cutoff are continuous and do not group just above or below the cutoff, and, in the absence of treatment, the student would get the same GPA results. If grouping or a jump occurs at the cutoff, it suggests that the data is biased. In the current study this may occur if the students, knowing the GPA cutoff, manipulated their results to increase their GPA to just above the cutoff.  
The first year GPA results are used to reduce the likelihood of bias as students are less likely to be aware of the GPA assessment and cutoff values.
As we do not have a sample of students who were not put on academic probation when below the cutoff to compare with, the frequency of the GPA results is used to assess if there is an observed jump at the cutoff. Figure 1 shows the regression of the frequency of the distance from cutoff values and is continuous through the cutoff point.  
Figure 1 replicates Figure 1 in the original report.
```{r, echo = FALSE, warning=FALSE}
data1A <- data1 %>% 
  mutate(freq = 1)

# replace variable freq by quantity in each group of dist_from_cut_round10
data1A <- data1A%>% 
  group_by(dist_from_cut_med10) %>% 
  mutate(freq = length(freq))

```

```{r, echo = FALSE, warning=FALSE}
data1A %>% 
  ggplot(aes(x = dist_from_cut_med10, y = freq)) + 
  geom_point(aes(color=data1A$dist_from_cut>0)) +
  geom_smooth(method = "glm", formula = y ~ poly(x, 3), se = FALSE)+
  geom_vline(xintercept = 0) + 
  labs(y = "Frequency count", x = "GPA distance from cutoff")
```

The observable characteristics were also assessed to determine if these variables are also continuous through the threshold. If any of the observations show significant discontinuity it is possible that a student with that characteristic is able to manipulate their grade to avoid being placed on academic probation.
Table 2 replicates Table 2 in the original report.
```{r, echo = FALSE, warning=FALSE}
val_check = function(x)
{
  model = lm(x ~ gpalscutoff + gpaXgpalscutoff + gpaXgpagrcutoff+ gpasqXgpagrcutoff, data = data_clean)
  a = coeftest(model, vcov = vcovCL, cluster = data_clean$clustervar)
  c(a[2,1], a[2, 4], a[2, 2], a[1, 1], a[1, 4], a[1, 2])
}
myvars = c('hsgrade_pct', 'totcredits_year1', 'age_at_entry', 'male', 'english','bpl_north_america','loc_campus1', 'loc_campus2', 'loc_campus3')
chardata <- data_clean[myvars]
#colnames(abc) = c('gpa below cutoff 1', 'p-value 1', 'sd-error 1', 'intercept 0', 'p value 0', 'sd-error 1')
answer = lapply(chardata, val_check)
table2 = do.call(rbind.data.frame, answer)
colnames(table2) <- c('GPA below cutoff (1)', 'P-Value (1)', 'Std.err (1)','Intercept (0)', 'P-Value (0)', 'Std.err (0)')
rownames(table2) <- myvars
formattable(table2, 
            align =c("c","c","c","c","c", "c"), 
            list(`Indicator Name` = formatter(
              "span", style = ~ style(color = "grey",font.weight = "bold")),
              `P-Value (1)`= color_tile('pink', 'lightgreen')))
```
English as a first language and a birthplace of North America
are the variables closest to being discontinuous however are not significant at the 5% level.   
Assessment of the assumption that data is continuous through the threshold (and hence, not biased) is met.  

#### RDD Analysis
```{r}
##creating subsets 
hsg_gr_med <- subset(data_clean, hsgrade_pct>50)
hsg_ls_med <- subset(data_clean, hsgrade_pct<=50)
male_data <- subset(data_clean, male==1)
female_data <- subset(data_clean,male==0)
Eng_data <- subset(data_clean,english==1)
noeng_data <- subset(data_clean,noenglish==1)
Data_sets <- list(data_clean,hsg_gr_med,hsg_ls_med,male_data,female_data,Eng_data, noeng_data)
```

##### Impact of Academic Probation on the next GPA result
The inferential data replicated is the impact of being placed on academic probation on the students subsequent GPA (of students who remain at university). It is noted in the original report that the assessment of impact on the subsequent GPA may be biased due to the loss of students (dropping out) after the first year. The removal of these student from the data can result in a positive impact as a number of students who would again have a GPA below the cutoff are not longer included in the sample. Detail on how the subsequent assessment in the original report to generate the conservative assessments is not provided therefore the replication performed is limited to removing students who have left school after the first year.
```{r}
nextGPA_fn = function(x)
{
  model3 = lm(nextGPA ~ gpalscutoff + gpaXgpalscutoff + gpaXgpagrcutoff, data = x)
  a = coeftest(model3, vcov = vcovCL, cluster = x$clustervar) 
  c(a[2,1], a[2, 4], a[2, 2], a[1, 1], a[1, 4], a[1, 2])
}
myvars2 = c('All Data', 'HSgrade above Median','HSgrade below Median','Male','Female','Eng 1st language', 'Eng not 1st language')
colnames = c('gpa below cutoff 1', 'p-value 1', 'sd-error 1', 'intercept 0', 'p value 0', 'sd-error 1')
answer = lapply(Data_sets, nextGPA_fn)
table4 = do.call(rbind.data.frame, answer)
colnames(table4) <- c('GPA below cutoff (1)', 'P-Value (1)', 'Std.err (1)','Intercept (0)', 'P-Value (0)', 'Std.err (0)')
rownames(table4) <- myvars2
formattable(table4, 
            align =c("c","c","c","c","c", "c"), 
            list(`Indicator Name` = formatter(
              "span", style = ~ style(color = "grey",font.weight = "bold")),
              `P-Value (1)`= color_tile('pink', 'lightgreen')))
```
Results of the above table show   

#### Critical Assessment
In replicating this data a number of issues were identified:
- There is no confirmed assessment of linear regression assumptions, only RDD assumptions have been addressed.  
- Data provided for replication is not the same as the data used in the report  
- details of how the data has been cleaned and adapted to run the regression models has not been included or discussed.  

_A replication study of this original report was found **_reference_**. Appendix 1 shows some of the replication of this report which does not use a quadratic term. Results of this report can be replicated exactly._


#### Free Roam
Data for the observable attributes of age and birthplace were not assessed as part of the original report. The free roam section of the report below assessed the impact of academic probation in the first year on the subsequent GPA based on the age of the student (when starting university) and the student birthplace (limited to North America or other).
```{r}
Age_17 <- subset(data_clean, age_at_entry==17)
Age_18 <- subset(data_clean, age_at_entry==18)
Age_19 <- subset(data_clean, age_at_entry==19)
Age_20 <- subset(data_clean, age_at_entry==20)
Age_21 <- subset(data_clean, age_at_entry==21)

BP_NA <- subset(data_clean,bpl_north_america==1)
BP_other <- subset(data_clean,bpl_north_america==0)


Data_sets2 <- list(data_clean,Age_17,Age_18,Age_19,Age_20,Age_21, BP_NA,BP_other)

Sl_lv <- subset(data_clean, age_at_entry<=19)
mat_age <- subset(data_clean, age_at_entry>19)

Data_sets3 <- list(data_clean,Sl_lv, mat_age)
```

```{r}
FR_fn = function(x)
{
  model6 = lm(nextGPA ~ gpalscutoff + gpaXgpalscutoff + gpaXgpagrcutoff, data = x)
  a = coeftest(model6, vcov = vcovCL, cluster = x$clustervar) 
  c(a[2,1], a[2, 4], a[2, 2], a[1, 1], a[1, 4], a[1, 2])
}
myvars = c('All Data', 'Age entry = 17','Age entry = 18','Age entry = 19','Age entry = 20','Age entry = 21', 'Birth place Nth America', 'Birth place Other')
colnames = c('gpa below cutoff 1', 'p-value 1', 'sd-error 1', 'intercept 0', 'p value 0', 'sd-error 1')
answer2 = lapply(Data_sets2, FR_fn)
table5 = do.call(rbind.data.frame, answer2)
colnames(table5) <- c('GPA below cutoff (1)', 'P-Value (1)', 'Std.err (1)','Intercept (0)', 'P-Value (0)', 'Std.err (0)')
rownames(table5) <- myvars
table5
formattable(table5, 
            align =c("c","c","c","c","c", "c"), 
            list(`Indicator Name` = formatter(
              "span", style = ~ style(color = "grey",font.weight = "bold")),
              `P-Value (1)`= color_tile('pink', 'lightgreen')))
```
___________________________________________________________________________________





Study: 
Lindo, Jason M., Nicholas J. Sanders, and Philip Oreopoulos. 2010. "Ability, Gender, and Performance Standards: Evidence from Academic Probation." American Economic Journal: Applied Economics, 2 (2): 95-117.DOI: 10.1257/app.2.2.95 

Section os the report:
OVERVIEW
overview of paper including main outcomes. 
overivew of replicated elements

DESCRIPTIVE REPLICATION
correctly sourced image of the publised results

INFERENTIAL REPLICATION
correctly sourced image of the original
replication process and issues encountered during replication

FIGURE REPLICATION
correctly sourced image of the original
replication process and issues encountered during replication

CRITICAL ASSESSMENT
critque of replicated analysis
include assumptions(with test fo assumptions where required), process and pitfalls

FREE ROAM
Rational for free roam choice and discussion of implications


CODE
Ensure it is commented and runs with no errors
